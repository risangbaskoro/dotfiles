#!/bin/bash

# Detect and install a package using the right package manager
install_package() {
  local pkg="$1"

  echo "ğŸ” Detecting package manager to install '$pkg'..."

  if [[ "$OSTYPE" == "darwin"* ]] && command -v brew &>/dev/null; then
    echo "ğŸº Installing $pkg via Homebrew..."
    brew install "$pkg"
  elif command -v pacman &>/dev/null; then
    echo "ğŸ¹ Installing $pkg via pacman..."
    sudo pacman -Sy --noconfirm "$pkg"
  elif command -v apk &>/dev/null; then
    echo "ğŸ‹ Installing $pkg via apk..."
    sudo apk add "$pkg"
  elif command -v apt &>/dev/null; then
    echo "ğŸ§ƒ Installing $pkg via apt..."
    sudo apt install -y "$pkg"
  elif command -v dnf &>/dev/null; then
    echo "ğŸŒ¶ Installing $pkg via dnf..."
    sudo dnf install -y "$pkg"
  elif command -v zypper &>/dev/null; then
    echo "ğŸ§€ Installing $pkg via zypper..."
    sudo zypper install -y "$pkg"
  elif command -v snap &>/dev/null; then
    echo "ğŸ“¦ Installing $pkg via snap..."
    sudo snap install "$pkg"
  else
    echo "âŒ No supported package manager found. Please install '$pkg' manually."
    exit 1
  fi
}

# Dependency check with prompt
dependency() {
  if command -v "$1" &>/dev/null || pacman -Qi "$1" &>/dev/null; then
    return 0
  fi

  read -rp "â“ Dependency '$1' not found. Install it? [Y/n] " choice
  if [[ "${choice,,}" != "n" ]]; then
    install_package "$1"
  else
    echo "âš ï¸ Skipping '$1'. Script may not work as expected."
  fi
}

if command -v apt &>/dev/null; then
  echo "ğŸ§ƒ Updating apt..."
  sudo apt update
fi

dependency "tree"
dependency "fzf"
dependency "stow"
dependency "delta"
dependency "neovim"
dependency "ripgrep"
dependency "gnupg"
dependency "clang"
dependency "cmake"
dependency "just"

